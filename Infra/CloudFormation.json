{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "ECR, ECS, VPC, Subnet, RouteTable, IGW + SSM Parameter Store Integration",
  "Parameters": {
    "ProjectName": {
      "Type": "String",
      "Default": "test-project"
    }
  },
  "Resources": {
    "BedrockApiKeyParam": {
      "Type": "AWS::SSM::Parameter",
      "Properties": {
        "Name": { "Fn::Sub": "/${ProjectName}/Bedrock_API_Key" },
        "Type": "String",
        "Value": "placeholder",
        "Description": "API key for Bedrock"
      }
    },
    "ECRRepository": {
      "Type": "AWS::ECR::Repository",
      "Properties": {
        "RepositoryName": { "Ref": "ProjectName" }
      }
    },
    "EC2VPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "192.168.20.0/24",
        "Tags": [{ "Key": "Name", "Value": { "Fn::Sub": "${ProjectName}-vpc" } }]
      }
    },
    "InternetGateway": {
      "Type": "AWS::EC2::InternetGateway"
    },
    "VPCGatewayAttachment": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": { "Ref": "EC2VPC" },
        "InternetGatewayId": { "Ref": "InternetGateway" }
      }
    },
    "EC2Subnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "EC2VPC" },
        "CidrBlock": "192.168.20.0/28",
        "MapPublicIpOnLaunch": true,
        "Tags": [{ "Key": "Name", "Value": { "Fn::Sub": "${ProjectName}-public-subnet" } }]
      }
    },
    "EC2RouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": { "Ref": "EC2VPC" },
        "Tags": [{ "Key": "Name", "Value": { "Fn::Sub": "${ProjectName}-public-rt" } }]
      }
    },
    "PublicRoute": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "VPCGatewayAttachment",
      "Properties": {
        "RouteTableId": { "Ref": "EC2RouteTable" },
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": { "Ref": "InternetGateway" }
      }
    },
    "SubnetRouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": { "Ref": "EC2Subnet" },
        "RouteTableId": { "Ref": "EC2RouteTable" }
      }
    },
    "EC2SecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Allow HTTP",
        "VpcId": { "Ref": "EC2VPC" },
        "SecurityGroupIngress": [
          { "IpProtocol": "tcp", "FromPort": 80, "ToPort": 80, "CidrIp": "0.0.0.0/0" }
        ]
      }
    },
    "IAMRoleEcsExecution": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{ "Effect": "Allow", "Principal": { "Service": "ecs-tasks.amazonaws.com" }, "Action": "sts:AssumeRole" }]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
        ],
        "Policies": [{
          "PolicyName": "GetParameterPolicy",
          "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [{ 
              "Effect": "Allow", 
              "Action": ["ssm:GetParameters"], 
              "Resource": [
                { "Fn::Sub": "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${ProjectName}/*" }
              ] 
            }]
          }
        }]
      }
    },
    "ECSCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": { "Ref": "ProjectName" }
      }
    },
    "ECSTaskDefinition": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "Family": { "Ref": "ProjectName" },
        "Cpu": "256",
        "Memory": "512",
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": ["FARGATE"],
        "ExecutionRoleArn": { "Fn::GetAtt": ["IAMRoleEcsExecution", "Arn"] },
        "ContainerDefinitions": [{
          "Name": "app",
          "Image": { "Fn::Sub": "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ProjectName}:latest" },
          "PortMappings": [{ "ContainerPort": 80 }],
          "Secrets": [
            { "Name": "Bedrock_API_Key", "ValueFrom": { "Ref": "BedrockApiKeyParam" } }
          ]
        }]
      }
    },
    "ECSService": {
      "Type": "AWS::ECS::Service",
      "Properties": {
        "ServiceName": { "Fn::Sub": "${ProjectName}-service" }, 
        "Cluster": { "Ref": "ECSCluster" },
        "TaskDefinition": { "Ref": "ECSTaskDefinition" },
        "LaunchType": "FARGATE",
        "DesiredCount": 1,
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "ENABLED",
            "Subnets": [{ "Ref": "EC2Subnet" }],
            "SecurityGroups": [{ "Ref": "EC2SecurityGroup" }]
          }
        }
      }
    }
  }
}